# The Ambrosus Node GraphQL API

## Overview
This document describes GraphQl API that is currently available only for Hermes nodes. Metrical and Analytical data currently unavailable.
As well as all data related to the organizations. To use it see our [RESTful API](https://ambrosus.docs.apiary.io/#reference).

GraphQL is a modern way of API design. Learn more on [official website](https://graphql.org/learn/).

## Table of contents
+ [Authentication](#Authentication)
+ [Queries](#Queries)
+ [Types](#Types)

## Authentication
Before you can start interacting with API you need to create an account. An account is a pair: address and secret.

Depending on the type of operation you want to perform you are required to provide one of two forms of authentication: signed content or token based.

For entity upload operations the body of the request needs to contain a `content.signature` field. It is generated by signing the [serialized](Serialization) `content.idData` object using the standard ethereum sign function and your private key.

For other operations (modifying accounts and querying entities) a token should be provided using the http authorization header with `AMB_TOKEN ...` .

There is a special third option where you provide a http authorization header `AMB ...` with your account private key. When doing so the gateway will calculate the signature for you. This mechanism can be enabled using a config parameter. __Warning__: Sharing your private key is a security risk. This mechanism should therefore only be used in development and testing environments.

__Note:__ All data is immutable, therefore, you will not find any mutations.

## Queries
All available queries are described in single query type. Below you can find detailed description as well as some examples.
```graphql
type Query {
    getAccounts(next: String, previous: String, limit: Int): AccountResults
    getAccount(address: String!): Account
    getAssets(next: String, previous: String, limit: Int): AssetResults
    getAsset(assetId: String!): Asset
    getEvents(next: String, previous: String, limit: Int): EventResults
    getEvent(eventId: String!): Event
    getBundles(next: String, previous: String, limit: Int): BundleResults
    getBundle(bundleId: String!): Bundle
}
```

### Table of queries
+ [getAccounts](#get-accounts)
+ [getAccount](#get-account)
+ [getAssets](#get-assets)
+ [getAsset](#get-asset)
+ [getEvents](#get-events)
+ [getEvent](#get-event)
+ [getBundles](#get-bundles)
+ [getBundle](#get-bundle)

### Get Accounts
Get information about several accounts.
#### Parameters
+ limit (optional) - Number of accounts to return per page (limited to 100)
+ next (optional) - the id of the next page. Take from response. Should be passed to retrieve next page.
+ previous (optional) - the id of the previous page. Take from response. Should be passed to retrieve previous page.
#### Example
Get list of Accounts with all available data. 1 items per page.
##### Request
POST on /graphql
```graphql
{
    getAccounts(limit: 1) {
        results {
            address,
            accessLevel,
            organization,
            permissions,
            registeredOn,
            registeredBy
        },
        hasNext,
        next,
        hasPrevious,
        previous
    }
}
```
##### Response
```json
{
    "data": {
        "getAccounts": {
            "results": [
                {
                    "address": "0x0175146aa084665ebcaE6A642887051220F3eBC2",
                    "accessLevel": 900,
                    "organization": "36",
                    "permissions": [
                        "create_asset",
                        "create_event",
                        "register_accounts",
                        "manage_accounts"
                    ],
                    "registeredOn": 1638891016,
                    "registeredBy": "0x0C6C7264E509430bcFa2469bA4eB738c94e6C75A"
                }
            ],
            "hasNext": true,
            "next": "eyIkb2lkIjoiNjFhZjdlMDhlMmFjMWQwMDFiMmM3Yjc1In0",
            "hasPrevious": false,
            "previous": "eyIkb2lkIjoiNjFhZjdlMDhlMmFjMWQwMDFiMmM3Yjc1In0"
        }
    }
}
```

### Get Account
Get information about one account.
#### Parameters
+ address (required) - An address of the account.
#### Example
Get one account with all available information.
##### Request
POST on /graphql
```graphql
{
    getAccount(address: "0x0175146aa084665ebcaE6A642887051220F3eBC2") {
        address,
        accessLevel,
        organization,
        permissions,
        registeredOn,
        registeredBy
    }
}
```
##### Response
```json
{
    "data": {
        "getAccount": {
            "address": "0x0175146aa084665ebcaE6A642887051220F3eBC2",
            "accessLevel": 900,
            "organization": "36",
            "permissions": [
                "create_asset",
                "create_event",
                "register_accounts",
                "manage_accounts"
            ],
            "registeredOn": 1638891016,
            "registeredBy": "0x0C6C7264E509430bcFa2469bA4eB738c94e6C75A"
        }
    }
}
```

### Get Assets
Get information about several assets.
#### Parameters
+ limit (optional) - Number of assets to return per page (limited to 100)
+ next (optional) - the id of the next page. Take from response. Should be passed to retrieve next page.
+ previous (optional) - the id of the previous page. Take from response. Should be passed to retrieve previous page.
#### Example
Get list of assets with all available information. One item per page.
##### Request
POST on /graphql
```graphql
{
    getAssets(limit: 1) {
        results {
            assetId,
            content {
                signature,
                idData {
                    createdBy,
                    timestamp,
                    sequenceNumber
                }
            },
            metadata {
                bundleId,
                bundleTransactionHash
            }
        },
        hasNext,
        next,
        hasPrevious,
        previous
    }
}
```
##### Response
```json
{
    "data": {
        "getAssets": {
            "results": [
                {
                    "assetId": "0x548ae3c7f5ca842debbe10bf7cb98900b86ec4a0c99e1dae60eb9718be27667e",
                    "content": {
                        "signature": "0x308607460ce61d1e1098fd23019120386abcfe9c4f7322d19c3a4947e495fe2a0f3098656d7369b8642b43e88abba92025890d8671f78d4c0dc08bd38b76c8bc1c",
                        "idData": {
                            "createdBy": "0x0175146aa084665ebcaE6A642887051220F3eBC2",
                            "timestamp": 1639128337,
                            "sequenceNumber": 0
                        }
                    },
                    "metadata": {
                        "bundleId": "0x420e564349e633c5e5d3dc14b9ed8b25eb3d15070a42a5abd90381838e482267",
                        "bundleTransactionHash": "0xf14a820bc974050d4d445cafa0c5373f3b6b7ddf6127ab064ecea716bf8eccf7"
                    }
                }
            ],
            "hasNext": true,
            "next": "WzE2MzkxMjgzMzcseyIkb2lkIjoiNjFiMzFkMTJlMmFjMWQwMDFiMmM3YmE4In1d",
            "hasPrevious": false,
            "previous": "WzE2MzkxMjgzMzcseyIkb2lkIjoiNjFiMzFkMTJlMmFjMWQwMDFiMmM3YmE4In1d"
        }
    }
}
```

### Get Asset
Get information about one asset.
#### Parameters
+ assetId (required) - the id of the asset.
### Example
Get one asset with all available information.
##### Request
```graphql
{
    getAsset(assetId: "0x548ae3c7f5ca842debbe10bf7cb98900b86ec4a0c99e1dae60eb9718be27667e") {
        assetId,
        content {
            signature,
            idData {
                createdBy,
                timestamp,
                sequenceNumber
            }
        },
        metadata {
            bundleId,
            bundleTransactionHash
        }
    }
}
```
##### Response
```json
{
    "data": {
        "getAsset": {
            "assetId": "0x548ae3c7f5ca842debbe10bf7cb98900b86ec4a0c99e1dae60eb9718be27667e",
            "content": {
                "signature": "0x308607460ce61d1e1098fd23019120386abcfe9c4f7322d19c3a4947e495fe2a0f3098656d7369b8642b43e88abba92025890d8671f78d4c0dc08bd38b76c8bc1c",
                "idData": {
                    "createdBy": "0x0175146aa084665ebcaE6A642887051220F3eBC2",
                    "timestamp": 1639128337,
                    "sequenceNumber": 0
                }
            },
            "metadata": {
                "bundleId": "0x420e564349e633c5e5d3dc14b9ed8b25eb3d15070a42a5abd90381838e482267",
                "bundleTransactionHash": "0xf14a820bc974050d4d445cafa0c5373f3b6b7ddf6127ab064ecea716bf8eccf7"
            }
        }
    }
}
```

### Get Events
Get information about several events.
#### Parameters
+ limit (optional) - Number of assets to return per page (limited to 100)
+ next (optional) - the id of the next page. Take from response. Should be passed to retrieve next page.
+ previous (optional) - the id of the previous page. Take from response. Should be passed to retrieve previous page.
#### Example
Get list of events with all available information. One item per page.
##### Request
POST on /graphql
```graphql
{
    getEvents(limit: 1) {
        results {
            eventId,
            content {
                signature,
                idData {
                    assetId,
                    createdBy,
                    accessLevel,
                    timestamp
                }
            }
        }
        hasNext,
        next,
        hasPrevious,
        previous
    }
}
```
##### Response
```json
{
  "data": {
    "getEvents": {
      "results": [
        {
          "eventId": "0x014f3fe358e6f35c04a072b588d761a0f4e8af9202e758eb053039e0b6113689",
          "content": {
            "signature": "0x306d49bffc539e23689d412ab2a6a8fb44dcfa0ec4e4b8c9195531e30c3de0105cb40465171b4f8f6f5bc53b91f1e754cdae7f6a781c7ab5ae6d4eaec915d91a1b",
            "idData": {
              "assetId": "0x8659186eb24d1100c8f710d4b19c80b3e6821a709aa6261d64650709a6b14163",
              "createdBy": "0x0175146aa084665ebcaE6A642887051220F3eBC2",
              "accessLevel": 0,
              "timestamp": 1639128838
            }
          }
        }
      ],
      "hasNext": true,
      "next": "WzE2MzkxMjg4MzgseyIkb2lkIjoiNjFiMzFmMDhlMmFjMWQwMDFiMmM3YmFjIn1d",
      "hasPrevious": false,
      "previous": "WzE2MzkxMjg4MzgseyIkb2lkIjoiNjFiMzFmMDhlMmFjMWQwMDFiMmM3YmFjIn1d"
    }
  }
}
```

### Get Event
Get information about one event.
#### Parameters
+ eventId (required) - the id of the event
#### Parameters
Get one event with all available information.
##### Request
POST on /graphql
```graphql
{
    getEvent(eventId: "0x014f3fe358e6f35c04a072b588d761a0f4e8af9202e758eb053039e0b6113689") {
        eventId,
            content {
                signature,
                idData {
                    assetId,
                    createdBy,
                    accessLevel,
                    timestamp
                }
            }
    }
}
```
##### Response
```json
{
    "data": {
        "getEvent": {
            "eventId": "0x014f3fe358e6f35c04a072b588d761a0f4e8af9202e758eb053039e0b6113689",
            "content": {
                "signature": "0x306d49bffc539e23689d412ab2a6a8fb44dcfa0ec4e4b8c9195531e30c3de0105cb40465171b4f8f6f5bc53b91f1e754cdae7f6a781c7ab5ae6d4eaec915d91a1b",
                "idData": {
                    "assetId": "0x8659186eb24d1100c8f710d4b19c80b3e6821a709aa6261d64650709a6b14163",
                    "createdBy": "0x0175146aa084665ebcaE6A642887051220F3eBC2",
                    "accessLevel": 0,
                    "timestamp": 1639128838
                }
            }
        }
    }
}
```

### Get Bundles
Get information about several bundles.
#### Parameters
+ limit (optional) - Number of assets to return per page (limited to 100)
+ next (optional) - the id of the next page. Take from response. Should be passed to retrieve next page.
+ previous (optional) - the id of the previous page. Take from response. Should be passed to retrieve previous page.
#### Example
Get list of bundles. One item per page
##### Request
```graphql
{
    getBundles(limit: 1) {
        results {
            bundleId
        },
        hasNext,
        next,
        hasPrevious,
        previous
    }
}
```
##### Response
```json
{
    "data": {
        "getBundles": {
            "results": [
                {
                    "bundleId": "0x9c811557ad4776cc32d7a62f03c010fa6641da71ee9564e6e5fa1525e2f51ca5"
                }
            ],
            "hasNext": true,
            "next": "eyIkb2lkIjoiNjFiMzFmM2QyMDQ3NTYwMDNiYTljZGZlIn0",
            "hasPrevious": false,
            "previous": "eyIkb2lkIjoiNjFiMzFmM2QyMDQ3NTYwMDNiYTljZGZlIn0"
        }
    }
}
```

### Get Bundle
Get one bundle.
#### Parameters
+ bundleId (required) - the id of the bundle
#### Example
Get on bundle with all available information
##### Request
POST ob /graphql
```graphql
{
    getBundle(bundleId: "0x9c811557ad4776cc32d7a62f03c010fa6641da71ee9564e6e5fa1525e2f51ca5") {
        bundleId
    }
}
```
##### Response
```json
{
    "data": {
        "getBundle": {
            "bundleId": "0x9c811557ad4776cc32d7a62f03c010fa6641da71ee9564e6e5fa1525e2f51ca5"
        }
    }
}
```

## Types
There are several types available through the graphql API, but this is not all available resources. [Full API](https://ambrosus.docs.apiary.io/#reference).

### Table of types
+ [Account](#account)
+ [AccountResults](#account-results)
+ [Asset](#asset)
+ [AssetContent](#asset-content)
+ [AssetIdData](#asset-iddata)
+ [AssetMetadata](#asset-meta-data)
+ [AssetResults](#asset-results)
+ [Bundle](#bundle)
+ [BundleResults](#bundle-results)
+ [Event](#event)
+ [EventContent](#event-content)
+ [EventIdData](#event-id-data)
+ [EventResults](#event-results)

### Account

An account represents an actor in the supply chain. This can be a person, a company, a location, etc.

It consists of a pair - a public identifier `address` (compatible with ethereum address) and a `secret` (compatible with ethereum private key). Additionally, an account has a list of permissions, which specify what actions user can perform and access levels, which specifies what data is user able to view.

Account can hold any number of following permissions:

* super_account - Almighty administrator account. Is able to perform all kinds of calls.
* protected_account - account protected from modification. Protected accounts can be created only by super accounts or other protected accounts. Only super accounts can modify the protected accounts.
* create_asset - allows account to create assets
* create_event - allows account to create events
* register_accounts - allows account to add new accounts
* manage_accounts - allows account to view and manage existing accounts

```graphql
type Account {
    address: String
    accessLevel: Int
    organization: String
    permissions: [String]
    registeredOn: Float
    registeredBy: String
}
```
#### Field description
+ address - An address of the account. 
+ accessLevel - Access level of the account. Should be a non-negative integer. 
+ organization - Identifier of the organization the account belongs to. 
+ permissions - A list of permissions granted to this account. 
+ registeredBy - The address which has registered the account. 
+ registeredOn - UNIX timestamp of account registration. 

### Account Results
The holder for result of accounts list request. Contains some helper data to handle pagination.
```graphql
type AccountResults {
    results: [Account!]!
    hasNext: Boolean
    next: String
    hasPrevious: Boolean
    previous: String
}
```
#### Field description
+ results - the list of Accounts. Can't be null as well as internal account items.
+ hasNext - shows if there is next page. 
+ next - the id of the next page. 
+ hasPrevious - shows if there is previous page. 
+ previous - the id of the previous page. 

### Asset
Assets are primary elements moving through a supply chain.
They are the nouns of the system. They can represent an ingredient, product, package of products
or any other type of container. An Asset on its own function only as a handle for an Event stream.
Because of this, they only contain an `idData` structure holding minimal information about their creation.
Assets are identified by an `assetId` field which is a sha3 hash calculated from the `content` field.

```graphql
type Asset {
    assetId: String
    content: AssetContent
    metadata: AssetMetaData
}
```
#### Fields description
+ assetId - Content-addressable identifier of the asset.
+ content - The AssetContent subtype
+ metadata - The AssetMetaData

### Asset Content
The subtype of Asset type.
```graphql
type AssetContent {
    signature: String
    idData: AssetIdData
}
```
#### Fields description
+ signature - elliptic-curve signature of the idData field signed with the creator's private address.
+ idData - the subtype described below.

### Asset IdData
The id data of the asset. Used in asset content.
```graphql
type AssetIdData {
    createdBy: String
    timestamp: Int
    sequenceNumber: Int
}
```
#### Field description
+ createdBy (string) - Public address of the asset creator.
+ timestamp (number) - UNIX timestamp of asset creation.
+ sequenceNumber (number) - Used to assure that all assets are unique.

### Asset Meta Data
The metadata field of the Asset.
```graphql
type AssetMetaData {
    bundleId: String
    bundleTransactionHash: String
}
```
#### Field description
+ bundleId (string) - If the asset has already been added to a bundle, Id of the bundle holding the event
+ bundleTransactionHash (string) - If the asset has already been added to a bundle, identifier of the transaction on which the proof of bundle has been uploaded.
More info on the transaction can be found under `http://explorer.ambrosus.io/#/tx/{bundleTransactionHash}`

### Asset Results
The holder type for the asset request results
```graphql
type AssetResults {
    results: [Asset]
    hasNext: Boolean
    next: String
    hasPrevious: Boolean
    previous: String
}
```
#### Fields description
+ results - the list of assets. Can't be null as well as internal asset items.
+ hasNext - shows if there is next page.
+ next - the id of the next page.
+ hasPrevious - shows if there is previous page.
+ previous - the id of the previous page.

### Bundle
Bundles are packages of data that are being published by ambrosus node users.
Single bundle contains assets, public events and stubs of private events, that user created since last bundle publication.
Bundles are used to exchange data between the users of ambrosus network.
Every bundle's Id is stored on the blockchain.
```graphql
type Bundle {
    bundleId: String
}
```
#### Field description
+ bundleId - Content-addressable identifier of the bundle (keccak hash of content.idData field).

### Bundle Results
The holder type for Bundles.
```graphql
type BundleResults {
    results: [Bundle!]!
    hasNext: Boolean
    next: String
    hasPrevious: Boolean
    previous: String
}
```
#### Field description
+ results - the list of bundles. Can't be null as well as internal bundle items.
+ hasNext - shows if there is next page.
+ next - the id of the next page.
+ hasPrevious - shows if there is previous page.
+ previous - the id of the previous page.

### Event
Events describe all registered changes of state that occurred with the asset. E.g. measured temperature, noted big acceleration or changing pallets.
An event consists of the 3 major parts:
* idData – Public information about an event. Contains the ID of the asset, address of the user who has registered the event, minimal access level required to view private data of the event and the timestamp of the event. Additionally, idData holds the hash of the Data field.
* Data – Protected information about an event. To get access to the private data, a user needs to have an access level not smaller than the returned event.
* Metadata – Information generated and used by AMB-NET, for example id of a bundle handling an event.

###### Events Data field

Every event has a `data` array, located at `content` with information what actually happened.
Each item in this array is an object with a required `type` field of `string` type.
Following event types are predefined:
* `ambrosus.asset.info` - Human readable information about an asset, such as its name, photos, description, etc.
* `ambrosus.asset.identifiers` - Known identifiers for an asset, must have at least 1 property of type `array`
* `ambrosus.event.identifiers` - Known identifiers for an event, must have at least 1 property of type `array`
* `ambrosus.asset.location` - Location of an asset. Can be expressed with geographical coordinates.
    * `geoJson`: geographical point described with geoJson formula (As described in RFC7946, The GeoJSON Format)
* `ambrosus.event.location` - Location of an event. Can be expressed with geographical coordinates.
    * `geoJson`: geographical point described with geoJson formula (As described in RFC7946, The GeoJSON Format)
```graphql
type Event {
eventId: String
content: EventContent
}
```
#### Fields description
+ eventId - Content-addressable identifier of the event.
+ content - The event content subtype.

### Event content
```graphql
type EventContent {
    signature: String
    idData: EventIdData
}
```
#### Fields description
+ signature - elliptic-curve signature of the idData field signed with the creator's private address.
+ idData - the event's idData subtype

### Event id Data
```graphql
type EventIdData {
    assetId: String
    createdBy: String
    accessLevel: Int
    timestamp: Float
}
```
#### Field description
+ assetId (string) - Id of an asset related to this event.
+ createdBy (string) - Public address of the event creator.
+ accessLevel (number) - The access level of the event. If the user's access level if lower than event's, the data field will not be returned.
+ timestamp (number) - UNIX timestamp of the event creation.

### Event Results
The holder type for event request
```graphql
type EventResults {
    results: [Event]
    hasNext: Boolean
    next: String
    hasPrevious: Boolean
    previous: String
}
```
#### Fields description
+ results - the list of event. Can't be null as well as internal event items.
+ hasNext - shows if there is next page.
+ next - the id of the next page.
+ hasPrevious - shows if there is previous page.
+ previous - the id of the previous page.
